steps:
  - name: gcr.io/cloud-builders/git
    args: [fetch, --depth=2]

  - name: "gcr.io/cloud-builders/git"
    id: "Get Previous Commit"
    entrypoint: "/bin/bash"
    args:
      - "-c"
      - |
        echo $(git diff --name-only HEAD~1 HEAD | grep services | cut -d "/" -f 2 | uniq) > /workspace/changed_dirs.txt

  - name: "gcr.io/cloud-builders/docker"
    id: "Build Changed Dockerfiles"
    entrypoint: "/bin/bash"
    args:
      - "-c"
      - |
        for dir in $(cat /workspace/changed_dirs.txt); do
          cd services/$dir
          docker build -t australia-southeast1-docker.pkg.dev/$PROJECT_ID/personal-workload-images/$dir:$COMMIT_SHA .
          docker push australia-southeast1-docker.pkg.dev/$PROJECT_ID/personal-workload-images/$dir:$COMMIT_SHA
          cd ../../
        done
